#!/bin/sh

modules="gconf types ext dag filepath filetype modname utils target project helper process filesystem tracker meta dist prog prepare configure building build obuild"
libs="unix"
OCAMLOPT=ocamlopt.opt

set -e 
time (cd src;
	rm -f *.cmi *.cmx *.o
	for mod in $modules
	do
		echo "COMPILING $mod"
		$OCAMLOPT -c ${mod}.ml
	done;
	echo "LINKING obuild.bootstrap"
	$OCAMLOPT -o obuild.bootstrap ${libs// /.cmxa }.cmxa ${modules// /.cmx }.cmx
	rm *.cmi *.cmx *.o
	mv obuild.bootstrap ..
)
./obuild.bootstrap clean
./obuild.bootstrap configure
time ./obuild.bootstrap build
# rm obuild.bootstrap
